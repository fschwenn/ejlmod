# -*- coding: utf-8 -*-
#harvest INFN theses
#FS: 2018-02-02


import getopt
import sys
import os
import urllib2
import urlparse
from bs4 import BeautifulSoup
import re
import ejlmod2
import codecs
import datetime
import time

xmldir = '/afs/desy.de/user/l/library/inspire/ejl'
retfiles_path = "/afs/desy.de/user/l/library/proc/retinspire/retfiles"


now = datetime.datetime.now()
stampoftoday = '%4d-%02d-%02d' % (now.year, now.month, now.day)

publisher = 'INFN'

typecode = 'T'

jnlfilename = 'THESES-INFN-2011-%s' % (stampoftoday)



tocurl = 'http://www.infn.it/thesis/'
#grep  'thesis_dettaglio.php?tid' infn2010_*html|sed 's/.*tid=//'|sed 's/<.*//'
#tids2010 = [8035, 7281, 6980, 6979, 6945, 6877, 6275, 5842, 5841, 5840, 5773, 5684, 5682, 5680, 5671, 5666, 5657, 5649, 5647, 5643, 5635, 5626, 5624, 5594, 5592, 5582, 5579, 5576, 5573, 5572, 5571, 5570, 5561, 5559, 5555, 5554, 5548, 5546, 5545, 5531, 5527, 5518, 5517, 5516, 5512, 5511, 5505, 5494, 5493, 5486, 5484, 5477, 5445, 5444, 5443, 5442, 5437, 5436, 5434, 5420, 5419, 5417, 5416, 5411, 5405, 5403, 5394, 5374, 5369, 5360, 5356, 5355, 5350, 5341, 5329, 5328, 5300, 5296, 5290, 5287, 5254, 5253, 5251, 5231, 5219, 5207, 5205, 5204, 5202, 5131, 5129, 5121, 5120, 5118, 5091, 5059, 5055, 5027, 5025, 5024, 5007, 4979, 4978, 4977, 4973, 4966, 4943, 4917, 4916, 4908, 4906, 4866, 4864, 4861, 4832, 4827, 4826, 4825, 4822, 4819, 4818, 4812, 4773, 4769, 4754, 4746, 4744, 4740, 4734, 4408, 4407, 4294, 4181, 4180, 4128, 4099, 4083, 4080, 4071, 4018, 3974, 3856, 3836, 3787, 3715, 3708, 3704, 3606, 3569, 3511, 3507, 3499, 3447, 3422, 1151, 663]
tids2011 = [11490, 10100, 8938, 8237, 8027, 7116, 7064, 6996, 6934, 6923, 6903, 6900, 6898, 6876, 6875, 6874, 6870, 6811, 6802, 6801, 6789, 6760, 6746, 6700, 6694, 6691, 6690, 6689, 6671, 6667, 6665, 6662, 6660, 6655, 6652, 6645, 6643, 6642, 6610, 6606, 6599, 6597, 6596, 6595, 6594, 6593, 6592, 6568, 6564, 6562, 6557, 6550, 6545, 6537, 6528, 6522, 6520, 6508, 6503, 6501, 6499, 6473, 6471, 6470, 6469, 6458, 6457, 6455, 6451, 6448, 6439, 6437, 6429, 6423, 6422, 6411, 6408, 6373, 6372, 6370, 6369, 6368, 6367, 6366, 6355, 6347, 6341, 6340, 6330, 6329, 6327, 6318, 6317, 6308, 6307, 6301, 6294, 6293, 6290, 6267, 6266, 6245, 6239, 6229, 6228, 6224, 6223, 6219, 6213, 6167, 6162, 6147, 6133, 6129, 6090, 6081, 6062, 6042, 6034, 6025, 6024, 6012, 6009, 5989, 5983, 5982, 5981, 5936, 5934, 5928, 5908, 5905, 5845, 5839, 5835, 5832, 5825, 5824, 5823, 5822, 5814, 5810, 5799, 5781, 5771, 5762, 5757, 5751, 5737, 5734, 5732, 5722, 5720, 5710, 5707, 5696, 5507, 5468, 5467, 5466, 5396, 5362, 5345, 5339, 5246, 5245, 5217, 5186, 5180, 5179, 5171, 5127, 5060, 5058, 5054, 5050, 5043, 5037, 5031, 5008, 5002, 5001, 5000, 4995, 4989, 4988, 4982, 4976, 4958, 4920]
tids2012 = [11402, 10215, 8268, 8267, 8128, 7979, 7966, 7962, 7952, 7943, 7920, 7910, 7909, 7908, 7907, 7903, 7902, 7901, 7895, 7876, 7867, 7855, 7841, 7837, 7836, 7830, 7799, 7789, 7772, 7768, 7761, 7753, 7718, 7717, 7710, 7681, 7680, 7679, 7663, 7628, 7616, 7615, 7610, 7591, 7589, 7588, 7584, 7578, 7576, 7575, 7573, 7564, 7541, 7536, 7530, 7529, 7528, 7527, 7526, 7493, 7489, 7444, 7426, 7403, 7382, 7381, 7380, 7379, 7358, 7357, 7355, 7351, 7347, 7340, 7339, 7336, 7325, 7313, 7299, 7286, 7280, 7267, 7264, 7260, 7251, 7250, 7237, 7226, 7224, 7220, 7219, 7214, 7213, 7210, 7209, 7206, 7201, 7199, 7198, 7196, 7195, 7194, 7189, 7185, 7184, 7174, 7146, 7144, 7103, 7098, 7076, 7058, 7056, 7054, 7047, 7044, 7043, 7041, 7040, 7025, 7012, 7004, 6995, 6986, 6985, 6975, 6968, 6965, 6961, 6954, 6944, 6943, 6937, 6932, 6928, 6927, 6922, 6916, 6910, 6880, 6871, 6859, 6858, 6856, 6855, 6852, 6850, 6848, 6847, 6837, 6824, 6819, 6818, 6814, 6806, 6748, 6622, 6618, 6613, 6581, 6540, 6481, 6474, 6472, 6425, 6306, 6299, 6298, 6295, 6276, 6274, 6222, 6221, 6185, 6139, 6108, 6097, 6096, 6017, 6011, 6004, 5951, 5869, 5210]
tids2013 = [11674, 11587, 10624, 9853, 9306, 9241, 9012, 8985, 8942, 8917, 8916, 8885, 8882, 8871, 8859, 8852, 8850, 8849, 8841, 8834, 8826, 8825, 8824, 8820, 8815, 8795, 8769, 8765, 8755, 8754, 8752, 8744, 8743, 8742, 8736, 8735, 8734, 8726, 8721, 8717, 8699, 8684, 8678, 8677, 8675, 8663, 8652, 8634, 8620, 8618, 8617, 8615, 8614, 8601, 8599, 8598, 8590, 8579, 8578, 8573, 8572, 8569, 8565, 8564, 8563, 8560, 8559, 8553, 8547, 8540, 8536, 8518, 8515, 8514, 8498, 8495, 8490, 8482, 8481, 8480, 8470, 8468, 8459, 8457, 8454, 8446, 8423, 8406, 8392, 8388, 8387, 8383, 8379, 8376, 8360, 8354, 8346, 8344, 8317, 8300, 8299, 8286, 8283, 8281, 8271, 8270, 8262, 8257, 8256, 8255, 8254, 8238, 8235, 8205, 8195, 8187, 8178, 8170, 8140, 8130, 8121, 8112, 8104, 8100, 8099, 8097, 8091, 8090, 8087, 8084, 8081, 8080, 8079, 8076, 8075, 8065, 8058, 8053, 8047, 8038, 8026, 7997, 7812, 7783, 7689, 7665, 7626, 7586, 7539, 7487, 7457, 7400, 7255, 7141, 7117, 7109, 7097, 7093, 7091, 7082, 7074, 7014]
tids2014 = [10012, 10009, 10002, 9987, 9891, 9832, 9826, 9802, 9782, 9775, 9774, 9773, 9758, 9757, 9752, 9741, 9724, 9719, 9713, 9677, 9649, 9645, 9634, 9621, 9614, 9603, 9591, 9578, 9570, 9565, 9552, 9548, 9545, 9537, 9528, 9525, 9523, 9519, 9514, 9507, 9504, 9502, 9501, 9499, 9498, 9497, 9487, 9486, 9475, 9462, 9460, 9437, 9428, 9427, 9425, 9413, 9398, 9397, 9382, 9381, 9378, 9377, 9369, 9367, 9351, 9350, 9343, 9335, 9320, 9298, 9295, 9292, 9287, 9286, 9285, 9249, 9247, 9242, 9234, 9233, 9230, 9215, 9201, 9198, 9196, 9195, 9175, 9168, 9150, 9134, 9096, 9077, 9069, 9061, 9060, 9041, 9024, 9004, 9003, 9002, 9001, 9000, 8999, 8990, 8979, 8976, 8971, 8965, 8964, 8963, 8960, 8959, 8956, 8950, 8947, 8939, 8921, 8913, 8910, 8908, 8907, 8906, 8899, 8898, 8888, 8887, 8872, 8778, 8746, 8715, 8668, 8574, 8532, 8473, 8390, 8216, 8196, 8146, 8145, 8141, 8131]
tids2015 = [11803, 11627, 11491, 11488, 10922, 10809, 10802, 10771, 10718, 10711, 10704, 10699, 10685, 10675, 10658, 10652, 10649, 10648, 10642, 10634, 10630, 10629, 10628, 10615, 10605, 10604, 10603, 10593, 10553, 10540, 10538, 10527, 10514, 10501, 10480, 10478, 10474, 10465, 10464, 10460, 10441, 10440, 10416, 10415, 10414, 10392, 10391, 10387, 10365, 10364, 10362, 10356, 10353, 10351, 10349, 10334, 10328, 10327, 10319, 10297, 10295, 10288, 10287, 10268, 10266, 10265, 10264, 10263, 10252, 10247, 10237, 10233, 10229, 10219, 10217, 10210, 10201, 10200, 10198, 10194, 10189, 10188, 10074, 10072, 10063, 10057, 10026, 10020, 10013, 10007, 10006, 10003, 10001, 10000, 9997, 9992, 9991, 9984, 9967, 9964, 9952, 9934, 9922, 9921, 9919, 9916, 9915, 9907, 9890, 9889, 9888, 9887, 9886, 9877, 9874, 9865, 9864, 9860, 9856, 9854, 9837, 9835, 9829, 9828, 9751, 9750, 9635, 9568, 9477, 9461, 9422, 9314, 9301, 9280, 9258, 9255, 9235, 9208, 9203, 9132, 9093, 9091, 9071, 9066, 9065, 9015, 9014, 8483]
tids2016 = [11804, 11705, 11597, 11596, 11568, 11567, 11557, 11537, 11534, 11533, 11523, 11522, 11517, 11512, 11511, 11508, 11507, 11494, 11492, 11487, 11462, 11461, 11445, 11443, 11436, 11428, 11425, 11421, 11420, 11409, 11408, 11394, 11378, 11372, 11355, 11344, 11327, 11318, 11316, 11308, 11306, 11294, 11278, 11276, 11265, 11247, 11246, 11236, 11230, 11207, 11205, 11201, 11200, 11191, 11190, 11152, 11145, 11144, 11138, 11123, 11117, 11114, 11108, 11092, 11086, 11079, 11045, 11024, 11016, 11010, 11004, 10988, 10979, 10975, 10972, 10971, 10970, 10969, 10943, 10941, 10906, 10879, 10877, 10848, 10845, 10844, 10838, 10824, 10823, 10822, 10821, 10820, 10810, 10803, 10801, 10800, 10792, 10791, 10789, 10773, 10768, 10767, 10765, 10764, 10761, 10758, 10757, 10755, 10738, 10737, 10710, 10709, 10669, 10616, 10596, 10589, 10555, 10554, 10551, 10513, 10511, 10510, 10504, 10484, 10482, 10476, 10456, 10429, 10412, 10403, 10381, 10369, 10340, 10289, 10284, 10277, 10197, 10139, 10138, 10136, 10085, 10071]
#tids2017 = [11805, 11773, 11755, 11733, 11724, 11722, 11717, 11716, 11715, 11711, 11708, 11704, 11701, 11700, 11699, 11696, 11695, 11643, 11642, 11623, 11611, 11607, 11605, 11604, 11602, 11600, 11595, 11586, 11580, 11559, 11554, 11398, 11374, 11373, 11356, 11341, 11311, 11309, 11293, 11283, 11279, 11218, 11181, 11141, 11140, 11126, 11125, 11124, 11095, 11071, 11043, 11041, 11033, 10958, 10957, 11800, 11799]

tids = tids2011

recs = []
i = 0
for tid  in tids:    
    i += 1
    arturl = 'http://www.infn.it/thesis/thesis_dettaglio.php?tid=%i' % (tid)
    print '---{ %i/%i }---{ %s }------' % (i, len(tids), arturl)
    try:
        artpage = BeautifulSoup(urllib2.build_opener(urllib2.HTTPCookieProcessor).open(arturl))
        time.sleep(8)
    except:
        print "retry %s in 180 seconds" % (arturl)
        time.sleep(180)
        artpage = BeautifulSoup(urllib2.build_opener(urllib2.HTTPCookieProcessor).open(arturl))
    rec = {'tc' : 'T', 'jnl' : 'BOOK', 'link' : arturl, 'supervisor' : []}
    rec['doi'] = '20.2000/INFN/%i' % (tid)
    tabelle = []
    for tr in artpage.body.find_all('tr'):
        trflat = []
        for child in tr.children:
            try:
                trflat.append(re.sub('  +', ' ', re.sub('[\n\t\r]', ' ', child.text).strip()))
            except:
                pass
        trflat.append(tr)
        tabelle.append(trflat)
    for tab in tabelle:
        if tab[0] == 'Ultimo aggiornamento':
            rec['date'] = re.sub('.*(2\d\d\d).*', r'\1', tab[1])
        elif tab[0] == 'Autore':
            rec['auts'] = [ tab[1] ]
        elif tab[0] == 'Esperimento':
            rec['note'] = [tab[1]]
        elif tab[0][:9] == 'Universit':
            rec['aff'] = [ tab[1] ]
        elif tab[0] == 'Titolo':
            rec['tit'] = tab[1]
        elif tab[0] == 'Abstract':
            rec['abs'] = tab[1]
        elif tab[0] == 'Relatore/i':
            rec['supervisor'].append([tab[1]])
        elif tab[0] == 'File PDF ':
            for a in tab[-1].find_all('a'):
                rec['FFT'] = a['href']
    recs.append(rec)

    
    
#closing of files and printing
xmlf    = os.path.join(xmldir,jnlfilename+'.xml')
xmlfile  = codecs.EncodedFile(codecs.open(xmlf,mode='wb'),'utf8')
ejlmod2.writeXML(recs,xmlfile,publisher)
xmlfile.close()
#retrival
retfiles_text = open(retfiles_path,"r").read()
line = jnlfilename+'.xml'+ "\n"
if not line in retfiles_text: 
    retfiles = open(retfiles_path,"a")
    retfiles.write(line)
    retfiles.close()
